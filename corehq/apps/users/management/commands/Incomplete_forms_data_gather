from corehq.apps.domain.dbaccessors import iter_domains

def get_latest_apps(domain):

    from corehq.apps.app_manager.models import Application
    key = [domain]

    results = Application.get_db().view(
        'app_manager/applications_brief',
        startkey=key + [{}],
        endkey=key,
        descending=True,
        reduce=False,
        include_docs=True,
    ).all()

    return results

def web_apps_enabled(app):
    try:
        cloudcare_enabled = app['doc']['cloudcare_enabled']
        return cloudcare_enabled
    except KeyError:
        return False

def incomplete_forms_on(app):
    try:
        cc_show_incomplete = app['doc']['profile']['properties']['cc-show-incomplete']
        return cc_show_incomplete == "yes"
    except KeyError:
        return False

domains = iter_domains()

for domain in domains:
    apps = get_latest_apps(domain)
    incomplete_forms_disabled_in_all_apps = True
    web_apps_enabled_at_least_one_app = False

    for app in apps:
        if incomplete_forms_on(app):
            incomplete_forms_disabled_in_all_apps = False
        if web_apps_enabled(app):
            web_apps_enabled_at_least_one_app = True
    if incomplete_forms_disabled_in_all_apps and web_apps_enabled_at_least_one_app:
        print(domain)
