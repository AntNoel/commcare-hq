{% extends "hqwebapp/base_section.html" %}
{% load compress %}
{% load hq_shared_tags %}
{% load static %}
{% load i18n %}

{% block stylesheets %}{{ block.super }}
  {% compress css %}
  <link type="text/less"
        rel="stylesheet"
        media="all"
        href="{% static 'registry/less/registry.less' %}" />
  <link type="text/less"
        rel="stylesheet"
        media="all"
        href="{% static 'registry/less/light_color_scheme.less' %}" />
  {% endcompress %}
{% endblock %}

{% requirejs_main 'registry/js/registry_edit' %}

{% block page_content %}
{% initial_page_data "registry" registry %}
{% initial_page_data "availableCaseTypes" available_case_types %}
{% initial_page_data "availableDomains" available_domains %}
{% initial_page_data "invitedDomains" invited_domains %}
{% registerurl "edit_registry_attr" domain '---' '---' %}
{% registerurl "manage_invitations" domain '---' %}
{% registerurl "manage_grants" domain '---' %}
{% registerurl "accept_registry_invitation" domain %}
{% registerurl "reject_registry_invitation" domain %}
<div id="edit-registry" class="registry-inlines">
  <div class="row">
    <div class="col-sm-6 col-md-4">
      <inline-edit params="
          value: '{{ registry.name|escapejs }}',
          containerClass: 'h3',
          url: '{% url "edit_registry_attr" registry.domain registry.slug 'name' %}',
          placeholder: '{% trans "Untitled Data Registry"|escapejs %}',
          rows: 1,
          nodeName: 'input',
          errorMessage: '{% trans "Name must not be blank" %}',
          disallow_edit: {{ is_owner|yesno:"false,true" }}
      "></inline-edit>
    </div>
    <div class="col-md-2 col-md-offset-2">
      <div class="pull-right">
        {% if is_owner %}
        <button type="button" class="btn" data-bind="
          click: toggleActiveState,
          class: is_active() ? 'btn-warning-light' : 'btn-success-light'
        ">
          <!-- ko if: is_active() -->
          <i class="fa fa-pause"></i>
          {% trans "Deactivate" %}
          <!-- /ko -->
          <!-- ko ifnot: is_active() -->
          <i class="fa fa-play"></i>
          {% trans "Activate" %}
          <!-- /ko -->
        </button>
        {% endif %}
        {% if not is_owner %}
        <span class="label" data-bind="
          class: is_active() ? 'btn-success-light' : 'btn-warning-light'
        ">
          <!-- ko if: is_active() -->
          <i class="fa fa-play"></i>
          {% trans "Active" %}
          <!-- /ko -->
          <!-- ko ifnot: is_active() -->
          <i class="fa fa-pause"></i>
          {% trans "Inactive" %}
          <!-- /ko -->
        </span>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-sm-8 col-md-6">
      {% if is_owner %}
      <inline-edit params="
            value: '{{ registry.description|escapejs }}',
            url: '{% url "edit_registry_attr" registry.domain registry.slug 'description' %}',
            placeholder: '{% trans "Enter data registry description here"|escapejs %}',
            cols: 50,
        "></inline-edit>
      {% endif %}
      {% if not is_owner %}
        <div class="registry-form-container text-muted">
          {% if registry.description %}<p>{{ registry.description }}</p>{% endif %}
          <p>
            {% blocktrans %}
            This registry is managed by the '{{ domain }}' project space.
            {% endblocktrans %}
          </p>
        </div>
      {% endif %}
    </div>
    <div class="col-md-2">
      <div class="btn-group pull-right">
        <button type="button" class="btn dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
          data-bind="class: invitationStatusClass"
        >
          {% trans "Invitation" %} <span data-bind="text: invitationStatusText"></span> <span class="caret"></span>
        </button>
        <ul class="dropdown-menu">
          <li><a href="#" data-bind="visible: showAccept, click: acceptInvitation"><i class="fa fa-check"></i> {% trans "Opt in" %}</a></li>
          <li><a href="#" data-bind="visible: showReject, click: rejectInvitation"><i class="fa fa-remove"></i> {% trans "Opt out" %}</a></li>
        </ul>
      </div>
    </div>
  </div>
  <div class="registry-form-container">
    <div class="row ko-inline-edit">
      <div class="col-md-5 read-only" data-bind="
        style: {cursor: is_owner ? 'pointer' : 'default'},
        openModal: 'edit-schema-modal', openModalIf: is_owner
      ">
        <div class="row">
          <div class="col-md-12">
            <strong>{% trans "Case Types" %}:</strong>
            {% if is_owner %}
            <span class="inline-edit-icon"><i class="fa fa-pencil"></i></span>
            {% endif %}
          </div>
        </div>
        <div class="row">
          <div class="col-md-12 controls">
            <textarea data-bind="value: schema().join(', ')" cols="50" disabled></textarea>
          </div>
        </div>
      </div>
    </div>
    <div class="row mt-4" data-bind="ifnot: domain_invitation.status() === 'accepted'">
      <div class="col-sm-12 col-md-8">
        <div class="alert alert-info">
        {% trans "You must opt-in to the registry before you are able to manage grants." %}
        </div>
      </div>
    </div>
    <div class="row mt-4" data-bind="if: domain_invitation.status() === 'accepted'">
      <div class="col-sm-12 col-md-8">
        <ul class="nav nav-tabs" role="tablist">
          {% if is_owner %}
          <li role="presentation" class="active">
            <a href="#domains" aria-controls="domains" role="tab" data-toggle="tab">
            {% trans "Project Spaces" %}
            </a>
          </li>
          {% endif %}
          <li role="presentation" class="{% if not is_owner %}active{% endif %}">
            <a href="#grants" aria-controls="grants" role="tab" data-toggle="tab">
            {% trans "Grants" %}
            </a>
          </li>
        </ul>

        <div class="tab-content mt-4">
          {% if is_owner %}
          <div role="tabpanel" class="tab-pane active" id="domains">
            <div class="row">
              <div class="col-md-2 col-md-offset-10">
                <div class="pull-right">
                  <button type="button" class="btn btn-primary" data-bind="openModal: 'add-project-space-modal'">
                    <i class="fa fa-plus"></i>
                    {% trans "Invite Project Space" %}
                  </button>
                </div>
              </div>
            </div>
            <div data-bind="ifnot: invitations().length">
              <p>
                {% blocktrans %}
                  No Project Spaces have been invited.
                {% endblocktrans %}
              </p>
            </div>
            <table class="table table-striped table-hover mt-3" data-bind="if: invitations().length">
              <thead>
                <tr>
                  <th class="col-sm-2">{% trans "Project Name" %}</th>
                  <th class="col-sm-2">{% trans "Status" %}</th>
                  <th class="col-sm-2">
                    <i class="fa fa-sort-amount-desc"></i>
                    {% trans "Invitation Date" %}
                  </th>
                  <th class="col-sm-2">{% trans "Response Date" %}</th>
                  <th class="col-sm-4">{% trans "Action" %}</th>
                </tr>
              </thead>
              <tbody>
              <!-- ko foreach: invitations() -->
                <tr>
                  <td data-bind="text: domain"></td>
                  <td>
                    <span class="label" data-bind="class: cssClass">
                      <i class="fa" data-bind="css: cssIcon"></i>
                      <span data-bind="text: statusText"></span>
                    </span>
                  </td>
                  <td data-bind="text: invitationDate"></td>
                  <td data-bind="text: responseDate"></td>
                  <td>
                    <button type="button" class="btn btn-default btn-xs" data-bind="openModal: 'remove-project-space-modal'" title="{% trans "Remove Project" %}">
                      <i class="fa fa-trash"></i>
                    </button>
                  </td>
                </tr>
              <!-- /ko -->
              </tbody>
            </table>
          </div>
          {% endif %}
          <div role="tabpanel" class="tab-pane {% if not is_owner %}active{% endif %}" id="grants">
            <div class="row">
              <div class="col-md-2 col-md-offset-10">
                <div class="pull-right">
                  <button type="button" class="btn btn-primary" data-bind="openModal: 'create-grant-modal'">
                    <i class="fa fa-plus"></i>
                    {% trans "Grant Access" %}
                  </button>
                </div>
              </div>
            </div>
            <div data-bind="ifnot: grants().length">
              <p>
                {% blocktrans %}
                  No grants have been created.
                {% endblocktrans %}
              </p>
            </div>
            <table class="table table-striped table-hover mt-3" data-bind="visible: grants().length">
              <thead>
                <tr>
                  <th class="col-sm-2">{% trans "From Project Space" %}</th>
                  <th class="col-sm-2">{% trans "To Project Spaces" %}</th>
                  <th class="col-sm-2">{% trans "Actions" %}</th>
                </tr>
              </thead>
              <tbody data-bind="foreach: sortedGrants">
                <tr>
                  <td data-bind="text: from_domain"></td>
                  <td data-bind="foreach: to_domains">
                    <span class="label label-default" data-bind="text: $data"></span>
                  </td>
                  <td>
                    <button type="button" class="btn btn-default btn-xs" data-bind="visible: canDelete, openModal: 'remove-grant-modal'" title="{% trans "Remove Grant" %}">
                      <i class="fa fa-trash"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>
<script type="text/html" id="remove-project-space-modal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title">{% trans "Remove Project Space" %}</h4>
        </div>
        <div class="modal-body">
          <div class='alert alert-warning'>
            {% blocktrans %}
              Removing a Project Space will completely remove their access to this registry.
            {% endblocktrans %}
          </div>
          <p>{% blocktrans %}
            Are you sure you want to remove <mark data-bind="text: domain"></mark>?</p>
          {% endblocktrans %}
        </div>
        <div class="modal-footer">
          <a href="#" class="btn btn-default" data-dismiss="modal">{% trans "Cancel" %}</a>
          <a href="#" class="btn btn-danger" data-bind="click: $root.removeDomain" data-dismiss="modal">{% trans "Remove" %}</a>
        </div>
      </div>
    </div>
</script>
<script type="text/html" id="add-project-space-modal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title">{% trans "Invite Project Spaces" %}</h4>
        </div>
        <div class="modal-body">
          <select multiple class="form-control" data-bind="select2: availableInviteDomains, selectedOptions: inviteDomains"></select>
        </div>
        <div class="modal-footer">
          <a href="#" class="btn btn-default" data-dismiss="modal">{% trans "Cancel" %}</a>
          <a href="#" class="btn btn-primary" data-bind="click: addDomain, enabled: invitedDomains().length" data-dismiss="modal">{% trans "Invite" %}</a>
        </div>
      </div>
    </div>
</script>
<script type="text/html" id="edit-schema-modal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title">{% trans "Edit Registry Case Types" %}</h4>
        </div>
        <div class="modal-body">
          <div class='alert alert-warning'>
            {% blocktrans %}
            Adding or removing case types may impact usages of the
              registry such as Configurable Reports and Case Search
            {% endblocktrans %}
          </div>
          <select multiple class="form-control" data-bind="select2: availableCaseTypes, selectedOptions: editedSchema"></select>
        </div>
        <div class="modal-footer">
          <a href="#" class="btn btn-default" data-dismiss="modal">{% trans "Cancel" %}</a>
          <a href="#" class="btn btn-primary" data-bind="click: saveSchema" data-dismiss="modal">{% trans "Save" %}</a>
        </div>
      </div>
    </div>
</script>
<script type="text/html" id="create-grant-modal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title">{% trans "Grant access" %}</h4>
        </div>
        <div class="modal-body">
          <div class='alert alert-warning'>
            {% blocktrans %}
            Granting access to data from {{ domain }}
            {% endblocktrans %}
          </div>
          <select multiple class="form-control" data-bind="select2: availableGrantDomains, selectedOptions: grantDomains"></select>
        </div>
        <div class="modal-footer">
          <a href="#" class="btn btn-default" data-dismiss="modal">{% trans "Cancel" %}</a>
          <a href="#" class="btn btn-primary" data-bind="click: createGrant" data-dismiss="modal">{% trans "Grant Access" %}</a>
        </div>
      </div>
    </div>
</script>
<script type="text/html" id="remove-grant-modal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title">{% trans "Remove Grant" %}</h4>
        </div>
        <div class="modal-body">
          {% blocktrans %}
            Are you sure you want to remove the grant from {{ domain }} to
          {% endblocktrans %}
          <mark data-bind="text: to_domains.join(', ')"></mark>
        </div>
        <div class="modal-footer">
          <a href="#" class="btn btn-default" data-dismiss="modal">{% trans "Cancel" %}</a>
          <a href="#" class="btn btn-primary" data-bind="click: $root.removeGrant" data-dismiss="modal">{% trans "Remove Grant" %}</a>
        </div>
      </div>
    </div>
</script>
{% endblock %}
