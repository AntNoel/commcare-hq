{% extends "hqwebapp/base_section.html" %}
{% load compress %}
{% load hq_shared_tags %}
{% load static %}
{% load i18n %}

{% block stylesheets %}{{ block.super }}
  {% compress css %}
  <link type="text/less"
        rel="stylesheet"
        media="all"
        href="{% static 'registry/less/registry.less' %}" />
  {% endcompress %}
{% endblock %}

{% requirejs_main 'registry/js/registry_edit' %}

{% block page_content %}
{% initial_page_data "registry" registry %}
{% initial_page_data "availableCaseTypes" available_case_types %}
{% initial_page_data "availableDomains" available_domains %}
{% registerurl "edit_registry_attr" registry.domain '---' '---' %}
{% registerurl "manage_invitations" registry.domain '---' %}
<div class="registry-inlines">
  <div class="row">
    <div class="col-sm-6 col-md-4">
      <inline-edit params="
          value: '{{ registry.name|escapejs }}',
          containerClass: 'h3',
          url: '{% url "edit_registry_attr" registry.domain registry.slug 'name' %}',
          placeholder: '{% trans "Untitled Data Registry"|escapejs %}',
          rows: 1,
          nodeName: 'input',
          errorMessage: '{% trans "Name must not be blank" %}',
      "></inline-edit>
    </div>
  </div>
  <div class="row">
    <div class="col-sm-8 col-md-6">
    <inline-edit params="
          value: '{{ registry.description|escapejs }}',
          url: '{% url "edit_registry_attr" registry.domain registry.slug 'description' %}',
          placeholder: '{% trans "Enter data registry description here"|escapejs %}',
          cols: 50,
      "></inline-edit>
    </div>
  </div>
</div>
<div id="edit-registry" class="registry-form-container">
  <div class="row ko-inline-edit" data-bind="openModal: 'edit-schema-modal'">
    <div class="col-md-5 read-only">
      <div class="row">
        <div class="col-md-12">
          <strong>{% trans "Case Types" %}:</strong>
          <span class="inline-edit-icon"><i class="fa fa-pencil"></i></span>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12 controls">
          <textarea data-bind="value: schema().join(', ')" cols="50" disabled></textarea>
        </div>
      </div>
    </div>
  </div>
  <div class="row mt-4">
    <div class="col-sm-12 col-md-8">
      <ul class="nav nav-tabs" role="tablist">
        <li role="presentation" class="active"><a href="#domains" aria-controls="domains" role="tab" data-toggle="tab">
          {% trans "Project Spaces" %}
        </a></li>
        <li role="presentation"><a href="#grants" aria-controls="grants" role="tab" data-toggle="tab">
          {% trans "Grants" %}
        </a></li>
      </ul>

      <div class="tab-content mt-4">
        <div role="tabpanel" class="tab-pane active" id="domains">
          <div class="row">
            <div class="col-md-2 col-md-offset-10">
              <div class="pull-right">
                <button type="button" class="btn btn-primary" data-bind="openModal: 'add-project-space-modal'">
                  <i class="fa fa-plus"></i>
                  {% trans "Invite Project Space" %}
                </button>
              </div>
            </div>
          </div>
          <div data-bind="ifnot: invitations().length">
            <p>
              {% blocktrans %}
                No Project Spaces have been invited.
              {% endblocktrans %}
            </p>
          </div>
          <table class="table table-striped table-hover mt-3" data-bind="if: invitations().length">
            <thead>
              <tr>
                <th class="col-sm-2">{% trans "Project Name" %}</th>
                <th class="col-sm-2">{% trans "Status" %}</th>
                <th class="col-sm-2">
                  <i class="fa fa-sort-amount-desc"></i>
                  {% trans "Invitation Date" %}
                </th>
                <th class="col-sm-2">{% trans "Response Date" %}</th>
                <th class="col-sm-4">{% trans "Action" %}</th>
              </tr>
            </thead>
            <tbody>
            <!-- ko foreach: invitations() -->
              <tr>
                <td data-bind="text: domain"></td>
                <td>
                  <span class="label label-muted" data-bind="css: cssClass">
                    <i class="fa" data-bind="css: cssIcon"></i>
                    <span data-bind="text: statusText"></span>
                  </span>
                </td>
                <td data-bind="text: invitationDate"></td>
                <td data-bind="text: responseDate"></td>
                <td>
                  <button type="button" class="btn btn-default btn-xs" data-bind="openModal: 'remove-project-space-modal'" title="{% trans "Remove Project" %}">
                    <i class="fa fa-trash"></i>
                  </button>
                </td>
              </tr>
            <!-- /ko -->
            </tbody>
          </table>
        </div>
        <div role="tabpanel" class="tab-pane" id="grants">
          <table class="table table-striped table-hover mt-3">
            <thead>
              <tr>
                <th class="col-sm-2">{% trans "From Project Space" %}</th>
                <th class="col-sm-2">{% trans "To Project Spaces" %}</th>
              </tr>
            </thead>
            <tbody>
            <!-- ko foreach: grants -->
              <tr>
                <td data-bind="text: from_domain"></td>
                <td data-bind="foreach: to_domains">
                  <span class="label label-default" data-bind="text: $data"></span>
                </td>
              </tr>
            <!-- /ko -->
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>
<script type="text/html" id="remove-project-space-modal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title">{% trans "Remove Project Space" %}</h4>
        </div>
        <div class="modal-body">
          <div class='alert alert-warning'>
            {% blocktrans %}
              Removing a Project Space will completely remove their access to this registry.
            {% endblocktrans %}
          </div>
          <p>{% blocktrans %}
            Are you sure you want to remove <span data-bind="text: domain"></span>?</p>
          {% endblocktrans %}
        </div>
        <div class="modal-footer">
          <a href="#" class="btn btn-default" data-dismiss="modal">{% trans "Cancel" %}</a>
          <a href="#" class="btn btn-danger" data-bind="click: $root.removeDomain" data-dismiss="modal">{% trans "Remove" %}</a>
        </div>
      </div>
    </div>
</script>
<script type="text/html" id="add-project-space-modal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title">{% trans "Invite Project Spaces" %}</h4>
        </div>
        <div class="modal-body">
          <select multiple class="form-control" data-bind="select2: availableDomains, value: inviteDomains"></select>
        </div>
        <div class="modal-footer">
          <a href="#" class="btn btn-default" data-dismiss="modal">{% trans "Cancel" %}</a>
          <a href="#" class="btn btn-primary" data-bind="click: addDomain, enabled: invitedDomains().length" data-dismiss="modal">{% trans "Invite" %}</a>
        </div>
      </div>
    </div>
</script>
<script type="text/html" id="edit-schema-modal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title">{% trans "Edit Registry Case Types" %}</h4>
        </div>
        <div class="modal-body">
          <div class='alert alert-warning'>
            {% blocktrans %}
            Adding or removing case types may impact usages of the
              registry such as Configurable Reports and Case Search
            {% endblocktrans %}
          </div>
          <select multiple class="form-control" data-bind="select2: availableCaseTypes, selectedOptions: editedSchema"></select>
        </div>
        <div class="modal-footer">
          <a href="#" class="btn btn-default" data-dismiss="modal">{% trans "Cancel" %}</a>
          <a href="#" class="btn btn-primary" data-bind="click: saveSchema" data-dismiss="modal">{% trans "Save" %}</a>
        </div>
      </div>
    </div>
</script>
{% endblock %}
